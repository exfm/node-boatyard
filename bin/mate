#!/usr/bin/env node

"use strict";

var os = require('os'),
    path = require('path'),
    nconf = require('nconf'),
    cluster = require('cluster'),
    winston = require('winston'),
    log = winston.loggers.get('shipyard'),
    hostname = os.hostname(),
    task = {};

nconf.argv()
    .env()
    .use('memory');

nconf.defaults({
    'captain': 'localhost',
    'hands': os.cpus().length,
    'task': '../examples/task.js'
});

var yard = require('../'),
    Mate = yard.Mate,
    Hand = yard.Hand,
    taskPath = path.resolve(nconf.get('task'));

task = require(taskPath);

if (cluster.isMaster){
    new Mate(hostname, nconf.get('captain'), Number(nconf.get('hands')))
        .allHandsOnDeck();
}
else {
    new Hand(hostname).getToWork(function(msg){
        log.silly('Working on partition ', msg);
        task.apply(this, [msg.partition]);
    });
}